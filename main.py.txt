import os, datetime, asyncio
from playwright.async_api import async_playwright
import requests

NOTION_TOKEN = os.getenv("NOTION_TOKEN")
DATABASE_ID = os.getenv("NOTION_DATABASE_ID")

async def fetch_price(keyword, platform):
    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=True)
        page = await browser.new_page()
        url = {
            "Shopee": f"https://shopee.tw/search?keyword={keyword}",
            "MOMO": f"https://www.momoshop.com.tw/mosearch/{keyword}.html",
            "ETmall": f"https://www.etmall.com.tw/Search?q={keyword}"
        }.get(platform, "")
        if url == "": return
        await page.goto(url)
        await page.wait_for_timeout(4000)
        await browser.close()
        return {
            "商品名稱": f"{keyword}（{platform}）",
            "平台": platform,
            "價格（TWD）": 4900,  # 可後續改成實際爬取價格
            "商品連結": url,
            "查詢時間": datetime.datetime.now().isoformat()
        }

def write_to_notion(data):
    requests.post(
        "https://api.notion.com/v1/pages",
        headers={
            "Authorization": f"Bearer {NOTION_TOKEN}",
            "Notion-Version": "2022-06-28",
            "Content-Type": "application/json"
        },
        json={
            "parent": {"database_id": DATABASE_ID},
            "properties": {
                "商品名稱": {"title": [{"text": {"content": data["商品名稱"]}}]},
                "平台": {"select": {"name": data["平台"]}},
                "價格（TWD）": {"number": data["價格（TWD）"]},
                "商品連結": {"url": data["商品連結"]},
                "查詢時間": {"date": {"start": data["查詢時間"]}},
            }
        }
    )

async def main():
    商品清單 = [("娜美妍筋膜槍", ["Shopee", "MOMO", "ETmall"])]
    for name, platforms in 商品清單:
        for platform in platforms:
            result = await fetch_price(name, platform)
            write_to_notion(result)

if __name__ == "__main__":
    asyncio.run(main())
